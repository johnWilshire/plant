<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>plant: A package for modelling forest trait ecology &amp; evolution: <em>Cohort spacing algorithm</em> • plant</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">plant</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/plant.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cohort_spacing.html">plant: A package for modelling forest trait ecology &amp; evolution: _Cohort spacing algorithm_</a>
    </li>
    <li>
      <a href="../articles/developer_notes.html">Developer Notes</a>
    </li>
    <li>
      <a href="../articles/emergent.html">plant: A package for modelling forest trait ecology &amp; evolution: _Patch-level emergent properties_</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">plant: A package for modelling forest trait ecology &amp; evolution: _Finding demographic equilibrium_</a>
    </li>
    <li>
      <a href="../articles/fitness.html">plant: A package for modelling forest trait ecology &amp; evolution: _Calculating fitness_</a>
    </li>
    <li>
      <a href="../articles/parameters.html">plant: A package for modelling forest trait ecology &amp; evolution: _Modifying parameters_</a>
    </li>
    <li>
      <a href="../articles/patch.html">plant: A package for modelling forest trait ecology &amp; evolution: _Patch-level dynamics_</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>plant: A package for modelling forest trait ecology &amp; evolution: <em>Cohort spacing algorithm</em>
</h1>
            
            <h4 class="date">2018-01-04</h4>
          </div>

    
    
<div class="contents">
<p>This vignette shows some details of cohort splitting. It’s probably not very interesting to most people, only those interested in knowing how the SCM technique works in detail. It also uses a lot of non-exported, non-documented functions from plant so you’ll see a lot of <code>plant:::</code> prefixes.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(plant)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">p0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span>(<span class="st">"FF16"</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">p &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_parameters.html">expand_parameters</a></span>(<span class="kw"><a href="../reference/trait_matrix.html">trait_matrix</a></span>(<span class="fl">0.0825</span>, <span class="st">"lma"</span>), p0, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">p<span class="op">$</span>seed_rain &lt;-<span class="st"> </span><span class="dv">20</span> <span class="co"># close to equilibrium</span></a></code></pre></div>
<p>The default cohort introduction times are designed to concentrate cohort introductions onto earlier times, based on empirical patterns of cohort refining:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">t1 &lt;-<span class="st"> </span>p<span class="op">$</span>cohort_schedule_times[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">plot</span>(t1, <span class="dt">cex=</span>.<span class="dv">2</span>, <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">ylab=</span><span class="st">"Time (years)"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-2-1.png"></p>
<p>The actual differences are stepped in order to increase the chance that cohorts from different species will be introduced at the same time and reduce the total amount of work being done.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">plot</span>(<span class="kw">diff</span>(t1), <span class="dt">log=</span><span class="st">"y"</span>, <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">cex=</span>.<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">     <span class="dt">ylab=</span><span class="st">"Time difference (years)"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-3-1.png"></p>
<p>We can create more refined schedules by interleaving points between these points:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">interleave &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  n &lt;-<span class="st"> </span><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  xp &lt;-<span class="st"> </span><span class="kw">c</span>(x[<span class="op">-</span>n] <span class="op">+</span><span class="st"> </span><span class="kw">diff</span>(x) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="kw">c</span>(<span class="kw">rbind</span>(x, xp))[<span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>n]</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">t2 &lt;-<span class="st"> </span><span class="kw">interleave</span>(t1)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">t3 &lt;-<span class="st"> </span><span class="kw">interleave</span>(t2)</a></code></pre></div>
<p>Consider running the SCM and computing seed rain at the end; this is one of the key outputs from the model so a reasonable one to look for differences in.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">run_with_times &lt;-<span class="st"> </span><span class="cf">function</span>(p, t) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  p<span class="op">$</span>cohort_schedule_times[[<span class="dv">1</span>]] &lt;-<span class="st"> </span>t</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="kw"><a href="../reference/run_scm.html">run_scm</a></span>(p)<span class="op">$</span>seed_rains</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">sr_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">run_with_times</span>(p, t1)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">sr_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">run_with_times</span>(p, t2)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">sr_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">run_with_times</span>(p, t3)</a></code></pre></div>
<p>Seed rain increases as cohorts are introduced more finely, though at a potentially saturating rate. We’re doing lots more work at the more refined end!</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">sr &lt;-<span class="st"> </span><span class="kw">c</span>(sr_<span class="dv">1</span>, sr_<span class="dv">2</span>, sr_<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">sr</a></code></pre></div>
<pre><code>## [1] 16.88934 16.87365 17.10484</code></pre>
<p>The differences in seed rain are not actually that striking (perhaps 1%) but in some runs can be more, and the <em>variation</em> creates instabilities.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">plot</span>(<span class="kw">c</span>(<span class="kw">length</span>(t1), <span class="kw">length</span>(t2), <span class="kw">length</span>(t3)), sr,</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">     <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Number of cohort introductions"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-7-1.png"></p>
<p>Where is the fitness difference coming from?</p>
<p>Consider adding a <em>single</em> additional cohort at one of the points along the first vector of times <code>t1</code> and computing fitness:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">insert_time &lt;-<span class="st"> </span><span class="cf">function</span>(i, x) {</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  j &lt;-<span class="st"> </span><span class="kw">seq_len</span>(i)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="kw">c</span>(x[j], (x[i] <span class="op">+</span><span class="st"> </span>x[i<span class="op">+</span><span class="dv">1</span>])<span class="op">/</span><span class="dv">2</span>, x[<span class="op">-</span>j])</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">run_with_insert &lt;-<span class="st"> </span><span class="cf">function</span>(i, p, t) {</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="kw">run_with_times</span>(p, <span class="kw">insert_time</span>(i, t))</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">}</a></code></pre></div>
<p>The internal function <code>plant:::run_scm_error</code> runs the SCM and computes errors as the integration proceeds; this helps shed some light.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">i &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">length</span>(t1) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">res &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(i, run_with_insert, p, t1))</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">tm &lt;-<span class="st"> </span>(t1[<span class="op">-</span>1L] <span class="op">+</span><span class="st"> </span>t1[<span class="op">-</span><span class="kw">length</span>(t1)]) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a></code></pre></div>
<p>The biggest deviations in output seed rain come about half way through the schedule:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">plot</span>(i, res <span class="op">-</span><span class="st"> </span>sr_<span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Index"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">0</span>, <span class="dt">col=</span><span class="st">"grey"</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-10-1.png"></p>
<p>Though because of the compression of early times it’s still fairly early:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">plot</span>(tm, res <span class="op">-</span><span class="st"> </span>sr_<span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Time (years)"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">0</span>, <span class="dt">col=</span><span class="st">"grey"</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-11-1.png"></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">ebt &lt;-<span class="st"> </span>plant<span class="op">:::</span><span class="kw"><a href="../reference/FF16.html">FF16_SCM</a></span>(p)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">ebt<span class="op">$</span><span class="kw">run</span>()</a></code></pre></div>
<p>Now look at the contribution of different cohorts to see rain (x axis log scaled for clarity). In this case almost all the contribution comes from early cohorts (this is essentially a single-age stand of pioneers). Overlaid on this are the five cohorts with the largest change in total fitness (biggest difference in red). The difference is not coming from seed rain contributions from those cohorts, which is basically zero, though it is higher than the surrounding cohorts.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">plot</span>(t1[<span class="op">-</span><span class="dv">1</span>], ebt<span class="op">$</span><span class="kw">seed_rain_cohort</span>(<span class="dv">1</span>)[<span class="op">-</span><span class="dv">1</span>], <span class="dt">log=</span><span class="st">"xy"</span>,</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">     <span class="dt">xlab=</span><span class="st">"Time (years)"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">j &lt;-<span class="st"> </span><span class="kw">order</span>(<span class="kw">abs</span>(res <span class="op">-</span><span class="st"> </span>sr_<span class="dv">1</span>), <span class="dt">decreasing=</span><span class="ot">TRUE</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="kw">abline</span>(<span class="dt">v=</span>tm[j], <span class="dt">col=</span><span class="kw">c</span>(<span class="st">"red"</span>, <span class="kw">rep</span>(<span class="st">"grey"</span>, <span class="dv">4</span>)))</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-12-1.png"></p>
<p>Next up, need to work out what the fitness contribution of each cohort is.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">dat1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span>(p)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">p2 &lt;-<span class="st"> </span>p</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">p2<span class="op">$</span>cohort_schedule_times[[<span class="dv">1</span>]] &lt;-<span class="st"> </span><span class="kw">insert_time</span>(j[[<span class="dv">1</span>]], t1)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">dat2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span>(p2)</a></code></pre></div>
<p>Then consider the light environment over time. This reconstructs the spline for the light environment for both runs, and computes canopy openness in both and computes the difference in light environments. The resulting image plot is blue in regions where the refined light environment is lighter (higher canopy openness) and red in regions where the the light environment is darker in the refined environment.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(e, h) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  i &lt;-<span class="st"> </span>plant<span class="op">:::</span><span class="kw"><a href="../reference/Interpolator.html">Interpolator</a></span>()</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  i<span class="op">$</span><span class="kw">init</span>(e[, <span class="dv">1</span>], e[, <span class="dv">2</span>])</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">  y &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(h))</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  j &lt;-<span class="st"> </span>h <span class="op">&lt;</span><span class="st"> </span>i<span class="op">$</span>max</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">  y[j] &lt;-<span class="st"> </span>i<span class="op">$</span><span class="kw">eval</span>(h[j])</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">  y</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">hmax &lt;-<span class="st"> </span><span class="kw">max</span>(dat1<span class="op">$</span>light_env[[<span class="kw">length</span>(dat1<span class="op">$</span>light_env)]][, <span class="st">"height"</span>])</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">h &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, hmax, <span class="dt">length.out=</span><span class="dv">201</span>)</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">y1 &lt;-<span class="st"> </span><span class="kw">sapply</span>(dat1<span class="op">$</span>light_env, f, h)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">y2 &lt;-<span class="st"> </span><span class="kw">sapply</span>(dat2<span class="op">$</span>light_env, f, h)[, <span class="op">-</span>(j[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>1L)]</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">dy &lt;-<span class="st"> </span><span class="kw">t</span>(y2 <span class="op">-</span><span class="st"> </span>y1)</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">dy[<span class="kw">abs</span>(dy) <span class="op">&lt;</span><span class="st"> </span><span class="fl">1e-10</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a></code></pre></div>
<p>ColorBrewer’s RdBu</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#B2182B"</span>, <span class="st">"#D6604D"</span>, <span class="st">"#F4A582"</span>, <span class="st">"#FDDBC7"</span>,</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">          <span class="st">"#D1E5F0"</span>, <span class="st">"#92C5DE"</span>, <span class="st">"#4393C3"</span>, <span class="st">"#2166AC"</span>)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">pal &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(cols)(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="kw">image</span>(dat1<span class="op">$</span>time, h, dy, <span class="dt">xlab=</span><span class="st">"Time (years)"</span>, <span class="dt">ylab=</span><span class="st">"Height (m)"</span>, <span class="dt">las=</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">      <span class="dt">col=</span>pal)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-15-1.png"></p>
<p>Because the differences are mostly manifest in the leaf area, we monitor error in both the leaf area and in fitness for all cohorts: (black line indicates the cohort identified as problematic above)</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">dat &lt;-<span class="st"> </span>plant<span class="op">:::</span><span class="kw">run_scm_error</span>(p)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw">image</span>(dat1<span class="op">$</span>time, dat1<span class="op">$</span>time, dat<span class="op">$</span>err<span class="op">$</span>lai[[<span class="dv">1</span>]],</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">      <span class="dt">xlab=</span><span class="st">"Patch age (years)"</span>, <span class="dt">ylab=</span><span class="st">"Introduction time (years)"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="kw">abline</span>(<span class="dt">h=</span>t1[j[[<span class="dv">1</span>]]])</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-16-1.png"></p>
<p>We then run through rounds of refining cohorts until estimated error has decreased down to an appropriate threshold:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">p_refined &lt;-<span class="st"> </span><span class="kw"><a href="../reference/build_schedule.html">build_schedule</a></span>(p)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">sr_refined &lt;-<span class="st"> </span><span class="kw">attr</span>(p_refined, <span class="st">"seed_rain_out"</span>)</a></code></pre></div>
<p>Each round, the algorithm looks at the error in the leaf area calculations and in the fitness calculations and refines the worst cohorts, repeating as necessary.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">t_refined &lt;-<span class="st"> </span>p_refined<span class="op">$</span>cohort_schedule_times[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">i &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">length</span>(t_refined) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">res &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(i, run_with_insert, p_refined, t_refined))</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">tm &lt;-<span class="st"> </span>(t1[<span class="op">-</span>1L] <span class="op">+</span><span class="st"> </span>t1[<span class="op">-</span><span class="kw">length</span>(t1)]) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a></code></pre></div>
<p>The problem cohorts are still in about the same place, but are much less pronounced (and less so if considering relative error)</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">plot</span>(i, res <span class="op">-</span><span class="st"> </span>sr_refined, <span class="dt">xlab=</span><span class="st">"Index"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">0</span>, <span class="dt">col=</span><span class="st">"grey"</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-19-1.png"></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">plot</span>(i, res <span class="op">/</span><span class="st"> </span>sr_refined <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Index"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)</a></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-19-2.png"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
